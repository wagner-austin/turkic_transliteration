name: Sync to Hugging Face Space

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'pyproject.toml'
  workflow_dispatch:  # Allow manual trigger

jobs:
  sync-space:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from pyproject.toml
        id: version
        run: |
          VERSION=$(grep -E '^version = ' pyproject.toml | sed -E 's/version = "(.*)"/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Detected version: $VERSION"

      - name: Clone Hugging Face Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_USERNAME: ${{ secrets.HF_USERNAME }}
        run: |
          git clone https://$HF_USERNAME:$HF_TOKEN@huggingface.co/spaces/$HF_USERNAME/turkic-transliteration-demo hf-space
          cd hf-space
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update Space to trigger rebuild
        working-directory: hf-space
        run: |
          # Update README with build info
          echo "" >> README.md
          echo "<!-- Last synced: $(date -u +"%Y-%m-%d %H:%M:%S UTC") from main repo version ${{ steps.version.outputs.version }} -->" >> README.md

          # Check if there are changes
          if git diff --quiet; then
            echo "No changes detected, creating empty commit to trigger rebuild"
            git commit --allow-empty -m "Trigger rebuild for PyPI version ${{ steps.version.outputs.version }}"
          else
            git add README.md
            git commit -m "Sync: Update for PyPI version ${{ steps.version.outputs.version }}"
          fi

      - name: Push to Hugging Face Space
        working-directory: hf-space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          git push origin main
          echo "Successfully pushed to Hugging Face Space!"
          echo "Your Space will rebuild automatically with the latest PyPI package."
